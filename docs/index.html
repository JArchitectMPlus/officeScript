<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV to Markdown Converter</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #fafafa;
            min-height: 100vh;
            padding: 0;
            line-height: 1.6;
            color: #1a1a1a;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }

        header {
            background: #1a1a1a;
            color: white;
            padding: 20px 40px;
            border-bottom: 1px solid #333;
        }

        header h1 {
            font-size: 1.5rem;
            font-weight: 400;
            letter-spacing: -0.5px;
        }

        header p {
            font-size: 0.875rem;
            color: #999;
            margin-top: 4px;
        }

        .content {
            padding: 40px;
        }

        .section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: #666;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        textarea {
            width: 100%;
            padding: 16px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            resize: vertical;
            transition: border-color 0.2s, box-shadow 0.2s;
            background: #fafafa;
        }

        textarea:focus {
            outline: none;
            border-color: #333;
            background: white;
            box-shadow: 0 0 0 1px #333;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .file-upload {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: white;
            color: #333;
        }

        .btn:hover {
            background: #fafafa;
            border-color: #333;
        }

        .btn:active {
            background: #f0f0f0;
        }

        .btn-primary {
            background: #1a1a1a;
            color: white;
            border-color: #1a1a1a;
        }

        .btn-primary:hover {
            background: #333;
            border-color: #333;
        }

        .btn-secondary {
            background: white;
            color: #666;
            border: 1px solid #e0e0e0;
        }

        .btn-secondary:hover {
            background: #fafafa;
            border-color: #999;
        }

        .btn-success {
            background: #333;
            color: white;
            border-color: #333;
        }

        .btn-success:hover {
            background: #1a1a1a;
        }

        .btn-danger {
            background: white;
            color: #666;
            border: 1px solid #ccc;
        }

        .btn-danger:hover {
            background: #f5f5f5;
            border-color: #999;
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .status {
            padding: 12px 16px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 10px;
            font-size: 0.875rem;
        }

        .status.show {
            display: flex;
        }

        .status-success {
            background: #f5f5f5;
            color: #333;
            border: 1px solid #e0e0e0;
        }

        .status-error {
            background: #1a1a1a;
            color: white;
            border: 1px solid #1a1a1a;
        }

        .status-info {
            background: #fafafa;
            color: #666;
            border: 1px solid #e0e0e0;
        }

        .meta-info {
            font-size: 0.75rem;
            color: #999;
            margin-top: 8px;
            letter-spacing: 0.5px;
        }

        input[type="file"] {
            display: none;
        }

        .file-label {
            padding: 10px 20px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            color: #666;
        }

        .file-label:hover {
            background: #fafafa;
            border-color: #999;
        }

        @media (max-width: 768px) {
            .content {
                padding: 24px;
            }

            header {
                padding: 16px 24px;
            }

            header h1 {
                font-size: 1.25rem;
            }

            .content {
                padding: 20px;
            }

            .controls {
                flex-direction: column;
            }

            .btn, .file-label {
                width: 100%;
                justify-content: center;
            }
        }

        .loader {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        .btn-secondary .loader,
        .btn-danger .loader {
            border-color: rgba(0, 0, 0, 0.1);
            border-top-color: #333;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>CSV to Markdown</h1>
            <p>Survey Data Converter</p>
        </header>

        <div class="content">
            <div id="statusMessage" class="status"></div>

            <div class="section">
                <h2 class="section-title">Input CSV Data</h2>
                <div class="input-group">
                    <textarea
                        id="csvInput"
                        rows="10"
                        placeholder="Paste your CSV data here..."></textarea>
                    <div class="meta-info" id="inputMeta">0 characters</div>
                </div>
                <div class="file-upload">
                    <label for="fileInput" class="file-label">
                        <span>üìÅ</span>
                        <span>Choose CSV File</span>
                    </label>
                    <input type="file" id="fileInput" accept=".csv,text/csv">
                    <button class="btn btn-danger" id="clearBtn">
                        <span>üóëÔ∏è</span>
                        <span>Clear</span>
                    </button>
                </div>
            </div>

            <div class="controls">
                <button class="btn btn-primary" id="convertBtn">
                    <span id="convertBtnText">Convert to Markdown</span>
                    <span id="convertLoader" class="loader hidden"></span>
                </button>
                <button class="btn btn-success" id="copyBtn" disabled>
                    <span>üìã</span>
                    <span>Copy to Clipboard</span>
                </button>
                <button class="btn btn-secondary" id="downloadBtn" disabled>
                    <span>üíæ</span>
                    <span>Download .md File</span>
                </button>
            </div>

            <div class="section">
                <h2 class="section-title">Markdown Output</h2>
                <div class="input-group">
                    <textarea
                        id="markdownOutput"
                        rows="20"
                        placeholder="Converted Markdown will appear here..."
                        readonly></textarea>
                    <div class="meta-info" id="outputMeta">0 characters, 0 lines</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function parseCSV(csvText) {
            const rows = [];
            let currentRow = [];
            let currentCell = '';
            let inQuotes = false;
            let i = 0;

            while (i < csvText.length) {
                const char = csvText[i];
                const nextChar = csvText[i + 1];

                if (inQuotes) {
                    if (char === '"') {
                        if (nextChar === '"') {
                            currentCell += '"';
                            i += 2;
                            continue;
                        } else {
                            inQuotes = false;
                            i++;
                            continue;
                        }
                    } else {
                        currentCell += char;
                        i++;
                        continue;
                    }
                }

                if (char === '"') {
                    inQuotes = true;
                    i++;
                    continue;
                }

                if (char === ',') {
                    currentRow.push(currentCell.trim());
                    currentCell = '';
                    i++;
                    continue;
                }

                if (char === '\r' && nextChar === '\n') {
                    currentRow.push(currentCell.trim());
                    if (currentRow.some(cell => cell !== '')) {
                        rows.push(currentRow);
                    }
                    currentRow = [];
                    currentCell = '';
                    i += 2;
                    continue;
                }

                if (char === '\n') {
                    currentRow.push(currentCell.trim());
                    if (currentRow.some(cell => cell !== '')) {
                        rows.push(currentRow);
                    }
                    currentRow = [];
                    currentCell = '';
                    i++;
                    continue;
                }

                currentCell += char;
                i++;
            }

            if (currentCell || currentRow.length > 0) {
                currentRow.push(currentCell.trim());
                if (currentRow.some(cell => cell !== '')) {
                    rows.push(currentRow);
                }
            }

            return rows;
        }

        function firstNonEmptyCell(row) {
            for (let cell of row) {
                const cellStr = String(cell).trim();
                if (cellStr && cellStr.toLowerCase() !== 'nan') {
                    return cellStr;
                }
            }
            return '';
        }

        function isQuestionRow(row) {
            const firstCell = firstNonEmptyCell(row);

            const questionPatterns = [
                /^[A-Z]\d+:/,
                /^\[.*\]/,
                /\?$/,
                /^CTP:/,
                /^h[A-Z]/
            ];

            for (let pattern of questionPatterns) {
                if (pattern.test(firstCell)) {
                    return true;
                }
            }

            if (firstCell.length > 50) {
                const keywords = ['what', 'how', 'which', 'please', 'following'];
                const hasKeyword = keywords.some(word => firstCell.toLowerCase().includes(word));

                if (hasKeyword) {
                    const responseIndicators = [
                        'marketing or advertising agency',
                        'business entity',
                        'educational institution',
                        'organization',
                        'government agency'
                    ];
                    const isResponse = responseIndicators.some(indicator =>
                        firstCell.toLowerCase().includes(indicator)
                    );
                    if (!isResponse) {
                        return true;
                    }
                }
            }

            return false;
        }

        function isHeaderRow(row) {
            const firstCell = firstNonEmptyCell(row);

            if (firstCell === 'Total') {
                const rowText = row.join(' ');
                if (rowText.includes('N=')) {
                    return true;
                }
            }

            const rowText = row.filter(cell => {
                const cellStr = String(cell).trim();
                return cellStr && cellStr.toLowerCase() !== 'nan';
            }).join(' ');

            if (rowText.includes('Total (A)')) {
                return true;
            }

            const specificHeaders = [
                'Pro-to-Pro Switchers (B)',
                'Software-to-Pro Switchers (C)',
                'Pro-to-Software Switchers (D)'
            ];

            if (specificHeaders.some(h => rowText.includes(h))) {
                return true;
            }

            return false;
        }

        function isDataRow(row) {
            const firstCell = firstNonEmptyCell(row);

            if (!firstCell || firstCell.toLowerCase() === 'nan') {
                return false;
            }

            if (isQuestionRow(row)) {
                return false;
            }

            const nonEmptyCells = row.filter(cell => {
                const cellStr = String(cell).trim();
                return cellStr && cellStr.toLowerCase() !== 'nan';
            });

            const numericCells = nonEmptyCells.filter(cell => /\d/.test(cell)).length;
            if (numericCells >= 2) {
                return true;
            }

            const responseCategories = [
                'Total', 'Mean', 'Median', 'Standard Deviation',
                'Yes', 'No', 'Male', 'Female', 'Other',
                'Very important', 'Somewhat important', 'Not important',
                'Strongly agree', 'Agree', 'Disagree',
                'Currently use', 'Used', 'Never used',
                'A marketing or advertising agency',
                'A business entity', 'An educational institution',
                'An organization or non-profit', 'A government agency'
            ];

            if (responseCategories.some(category => firstCell.includes(category))) {
                return true;
            }

            return firstCell.length > 0 && firstCell.length < 120;
        }

        function findQuestionBoundaries(data) {
            const boundaries = [];
            for (let i = 0; i < data.length; i++) {
                if (isQuestionRow(data[i])) {
                    boundaries.push(i);
                }
            }
            return boundaries;
        }

        function combineHeaders(allHeaderRows, data, questionStart, questionEnd) {
            const headerRows = [];
            let descriptiveHeaders = null;
            let totalHeaders = null;

            const switcherLabels = [
                'Pro-to-Pro Switchers (B)',
                'Software-to-Pro Switchers (C)',
                'Pro-to-Software Switchers (D)'
            ];

            for (let headerRow of allHeaderRows) {
                const headerText = headerRow.join(' ');

                if (headerText.includes('Total (A)') ||
                    switcherLabels.some(lbl => headerText.includes(lbl))) {
                    descriptiveHeaders = headerRow;
                }

                if (headerText.includes('N=') || /N=\d+/.test(headerText)) {
                    totalHeaders = headerRow;
                }
            }

            if (!totalHeaders) {
                for (let rowIdx = questionStart + 1; rowIdx < questionEnd; rowIdx++) {
                    const row = data[rowIdx];
                    const cells = row.filter(c => {
                        const cStr = String(c).trim();
                        return cStr && cStr.toLowerCase() !== 'nan';
                    });

                    if (cells.some(c => /N=\d+/.test(c))) {
                        totalHeaders = row.map(cell => {
                            const cellStr = String(cell).trim();
                            return (cellStr && cellStr.toLowerCase() !== 'nan') ? cellStr : '';
                        });
                        break;
                    }
                }
            }

            if (!totalHeaders) {
                const startAbove = Math.max(0, questionStart - 6);
                for (let rowIdx = startAbove; rowIdx < questionStart; rowIdx++) {
                    const row = data[rowIdx];
                    const cells = row.filter(c => {
                        const cStr = String(c).trim();
                        return cStr && cStr.toLowerCase() !== 'nan';
                    });

                    if (cells.some(c => /N=\d+/.test(c))) {
                        totalHeaders = row.map(cell => {
                            const cellStr = String(cell).trim();
                            return (cellStr && cellStr.toLowerCase() !== 'nan') ? cellStr : '';
                        });
                        break;
                    }
                }
            }

            if (descriptiveHeaders) {
                headerRows.push(descriptiveHeaders);
            }
            if (totalHeaders) {
                headerRows.push(totalHeaders);
            }

            return headerRows;
        }

        function formatQuestionSection(questionNum, questionText, headerRows, dataRows) {
            let content = `### Question ${questionNum}\n\n`;
            content += `**${questionText}**\n\n`;

            if (!headerRows.length && !dataRows.length) {
                content += '*No response data available for this question.*\n\n';
                return content;
            }

            let tableHeaders;
            if (headerRows.length > 0) {
                tableHeaders = headerRows[0];
            } else {
                const maxCols = Math.max(...dataRows.map(row => row.length));
                tableHeaders = Array.from({length: maxCols}, (_, i) => `Column ${i + 1}`);
            }

            if (dataRows.length > 0) {
                content += '#### Response Data\n\n';

                content += '| ' + tableHeaders.map(h => String(h)).join(' | ') + ' |\n';
                content += '|' + '---|'.repeat(tableHeaders.length) + '\n';

                if (headerRows.length > 1) {
                    const secondary = headerRows[1];
                    const secRow = [];
                    for (let i = 0; i < tableHeaders.length; i++) {
                        secRow.push(secondary[i] || '');
                    }
                    content += '| ' + secRow.map(c => String(c)).join(' | ') + ' |\n';
                }

                for (let dataRow of dataRows) {
                    const cleanRow = [];
                    for (let i = 0; i < tableHeaders.length; i++) {
                        const cell = dataRow[i] || '';
                        const cleanCell = String(cell).replace(/\|/g, '\\|').replace(/\n/g, ' ');
                        cleanRow.push(cleanCell);
                    }
                    content += '| ' + cleanRow.join(' | ') + ' |\n';
                }

                content += '\n';
            }

            return content;
        }

        function convertToMarkdown(data, filename = 'Survey Data') {
            if (!data || data.length === 0) {
                return `# ${filename}\n\n*This file is empty.*\n`;
            }

            const fileTitle = filename.replace(/_/g, ' ').replace('.csv', '');
            let markdown = `# ${fileTitle}\n\n`;

            const today = new Date();
            const dateStr = today.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            const maxCols = Math.max(...data.map(row => row.length));
            markdown += `**Total Records:** ${data.length}  \n`;
            markdown += `**Total Columns:** ${maxCols}  \n`;
            markdown += `**Generated:** ${dateStr}  \n\n`;
            markdown += '## Survey Questions and Responses\n\n';

            const questionBoundaries = findQuestionBoundaries(data);

            let questionNumber = 0;

            for (let i = 0; i < questionBoundaries.length; i++) {
                const questionStart = questionBoundaries[i];
                const questionEnd = i + 1 < questionBoundaries.length
                    ? questionBoundaries[i + 1]
                    : data.length;

                const questionText = String(data[questionStart][0]).trim();

                const allHeaderRows = [];
                const sectionData = [];

                for (let rowIdx = questionStart + 1; rowIdx < questionEnd; rowIdx++) {
                    const row = data[rowIdx];

                    if (isHeaderRow(row)) {
                        const headers = row.map(cell => {
                            const cellStr = String(cell).trim();
                            return (cellStr && cellStr.toLowerCase() !== 'nan') ? cellStr : '';
                        });
                        allHeaderRows.push(headers);
                    } else if (isDataRow(row)) {
                        const dataRow = row.map(cell => {
                            const cellStr = String(cell).trim();
                            return (cellStr && cellStr.toLowerCase() !== 'nan') ? cellStr : '';
                        });
                        if (dataRow.some(c => c !== '')) {
                            sectionData.push(dataRow);
                        }
                    }
                }

                const headerRows = combineHeaders(allHeaderRows, data, questionStart, questionEnd);

                if (headerRows.length > 0 || sectionData.length > 0) {
                    questionNumber++;
                    markdown += formatQuestionSection(
                        questionNumber,
                        questionText,
                        headerRows,
                        sectionData
                    );
                }
            }

            markdown += '## Summary\n\n';
            markdown += `**Total Questions Processed:** ${questionNumber}  \n`;
            markdown += `**Source File:** ${filename}  \n`;

            return markdown;
        }

        const csvInput = document.getElementById('csvInput');
        const fileInput = document.getElementById('fileInput');
        const clearBtn = document.getElementById('clearBtn');
        const convertBtn = document.getElementById('convertBtn');
        const copyBtn = document.getElementById('copyBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const markdownOutput = document.getElementById('markdownOutput');
        const statusMessage = document.getElementById('statusMessage');
        const inputMeta = document.getElementById('inputMeta');
        const outputMeta = document.getElementById('outputMeta');
        const convertBtnText = document.getElementById('convertBtnText');
        const convertLoader = document.getElementById('convertLoader');

        let currentFilename = 'survey_data.csv';

        csvInput.addEventListener('input', () => {
            const chars = csvInput.value.length;
            inputMeta.textContent = `${chars.toLocaleString()} characters`;
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                currentFilename = file.name;
                const reader = new FileReader();
                reader.onload = (event) => {
                    csvInput.value = event.target.result;
                    csvInput.dispatchEvent(new Event('input'));
                    showStatus('File loaded successfully: ' + file.name, 'success');
                };
                reader.onerror = () => {
                    showStatus('Error reading file', 'error');
                };
                reader.readAsText(file);
            }
        });

        clearBtn.addEventListener('click', () => {
            csvInput.value = '';
            markdownOutput.value = '';
            fileInput.value = '';
            currentFilename = 'survey_data.csv';
            copyBtn.disabled = true;
            downloadBtn.disabled = true;
            inputMeta.textContent = '0 characters';
            outputMeta.textContent = '0 characters, 0 lines';
            hideStatus();
        });

        convertBtn.addEventListener('click', () => {
            const csvText = csvInput.value.trim();

            if (!csvText) {
                showStatus('Please paste CSV data or upload a file', 'error');
                return;
            }

            convertBtnText.textContent = 'Converting...';
            convertLoader.classList.remove('hidden');
            convertBtn.disabled = true;

            setTimeout(() => {
                try {
                    const data = parseCSV(csvText);

                    if (data.length === 0) {
                        throw new Error('No data found in CSV');
                    }

                    const markdown = convertToMarkdown(data, currentFilename);
                    markdownOutput.value = markdown;

                    const lines = markdown.split('\n').length;
                    outputMeta.textContent = `${markdown.length.toLocaleString()} characters, ${lines.toLocaleString()} lines`;

                    copyBtn.disabled = false;
                    downloadBtn.disabled = false;

                    showStatus(`Successfully converted ${data.length} rows to Markdown`, 'success');
                } catch (error) {
                    showStatus('Error: ' + error.message, 'error');
                    console.error(error);
                } finally {
                    convertBtnText.textContent = 'Convert to Markdown';
                    convertLoader.classList.add('hidden');
                    convertBtn.disabled = false;
                }
            }, 100);
        });

        copyBtn.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(markdownOutput.value);
                showStatus('Markdown copied to clipboard!', 'success');
            } catch (error) {
                markdownOutput.select();
                document.execCommand('copy');
                showStatus('Markdown copied to clipboard!', 'success');
            }
        });

        downloadBtn.addEventListener('click', () => {
            const blob = new Blob([markdownOutput.value], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFilename.replace('.csv', '_SURVEY.md');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showStatus('Markdown file downloaded!', 'success');
        });

        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = 'status show status-' + type;

            if (type === 'success') {
                setTimeout(hideStatus, 5000);
            }
        }

        function hideStatus() {
            statusMessage.classList.remove('show');
        }
    </script>
</body>
</html>
